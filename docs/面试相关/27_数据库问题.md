# 27 数据库问题

## 134. 数据库连接池

### 系统中是否使用了数据库连接池？
是的。项目使用Spring Boot默认的HikariCP连接池，这是目前性能最好的Java数据库连接池。在`api-gateway-center`模块中配置了MySQL数据源。

### 如何配置数据库连接池？
在`application.yml`中配置：`spring.datasource.url`（MySQL连接URL）、`username`（root）、`password`（123456）、`driver-class-name`（com.mysql.cj.jdbc.Driver）。HikariCP默认配置：最大连接数10、最小空闲连接10、连接超时30秒。

### 数据库连接池的性能如何？
HikariCP性能优异，连接获取时间<1ms，支持高并发访问。项目中数据库主要用于配置管理，热数据缓存在Redis中，数据库压力较小，连接池性能表现良好。

### 如何监控数据库连接池的使用情况？
可通过以下方式监控：

1) Spring Boot Actuator暴露连接池指标；

2) MyBatis-Plus的SQL日志（`log-impl: StdOutImpl`）记录SQL执行情况；

3) 数据库慢查询日志；

4) 集成Prometheus监控连接池使用率；

5) 定期检查连接泄漏。

## 135. SQL优化

### 如何优化SQL查询？
1) 为常用查询字段创建索引（如`server_name`、`safe_key`、`interface_uri`）；

2) 使用MyBatis-Plus的`LambdaQueryWrapper`避免全表扫描；

3) 查询结果缓存到Redis；

4) 使用`LIMIT`分页查询；

5) 只查询必要字段，避免`SELECT *`。

### 如何使用索引提高查询速度？
项目中已创建多个索引：

1) **主键索引**：所有表的`id`字段；

2) **唯一索引**：`gateway_group.group_key`、`gateway_server.safe_key`；

3) **普通索引**：`gateway_interface.server_id`、`gateway_rate_limit.limit_type/limit_target/status`；

4) **联合索引**：`gateway_group_detail(group_id, detail_address)`。

### 如何避免全表扫描？
1) 使用索引字段作为查询条件；

2) 避免在索引字段使用函数或表达式；

3) 使用`LIMIT`限制返回行数；

4) 避免使用`!=`或`NOT IN`；

5) MyBatis-Plus的`last("limit 1")`限制查询结果。

### 如何分析SQL的执行计划？
使用`EXPLAIN`分析SQL执行计划，关注：

1) **type**：是否使用索引（ref/range/index）；

2) **key**：使用了哪个索引；

3) **rows**：扫描行数；

4) **Extra**：是否使用了临时表或文件排序。MyBatis-Plus的SQL日志可查看实际执行的SQL。

## 136. 事务处理

### 系统中如何处理事务？
使用Spring的`@Transactional`注解管理事务。在`GatewayInterfaceServiceImpl.create()`和`GatewayRateLimitServiceImpl`的增删改方法上使用`@Transactional(rollbackFor = Exception.class)`，确保操作原子性。

### 事务的隔离级别有哪些？
MySQL支持4种隔离级别：

1) **READ_UNCOMMITTED**：读未提交；

2) **READ_COMMITTED**：读已提交；

3) **REPEATABLE_READ**：可重复读（MySQL默认）；

4) **SERIALIZABLE**：串行化。项目使用默认的REPEATABLE_READ级别。

### 如何处理事务的死锁？
1) 保持事务简短，减少锁持有时间；

2) 按相同顺序访问表和行；

3) 使用合理的索引减少锁范围；

4) 捕获死锁异常并重试；

5) 设置合理的锁等待超时时间。MySQL会自动检测死锁并回滚其中一个事务。

### 如何实现事务的回滚？
通过`@Transactional(rollbackFor = Exception.class)`配置，任何异常都会触发回滚。代码中抛出`RuntimeException`会自动回滚事务。对于已发布的Redis消息无法回滚，需要发送补偿消息。

## 137. 数据一致性

### 如何保证数据的一致性？
1) **数据库事务**：单个操作使用事务保证原子性；

2) **缓存同步**：数据变更后同步更新Redis缓存；

3) **消息通知**：通过Redis Pub/Sub通知所有节点更新；

4) **定时同步**：定时任务从数据库同步数据到Redis；

5) **版本号机制**：避免旧数据覆盖新数据。

### 如何处理并发更新的冲突？
1) 使用数据库事务的行锁；

2) 使用`update_time`字段检测并发修改；

3) 对于限流配置，使用Redis的原子操作；

4) 重要操作记录操作日志，便于追溯；

5) 冲突时返回错误，由客户端重试。

### 如何实现乐观锁和悲观锁？
**乐观锁**：MyBatis-Plus支持`@Version`注解实现乐观锁，更新时检查版本号。**悲观锁**：使用`SELECT ... FOR UPDATE`加行锁。项目中主要使用乐观锁，通过`update_time`字段检测冲突。

### 如何处理数据的不一致？
1) **检测不一致**：定时任务对比数据库和Redis数据；

2) **自动修复**：发现不一致时从数据库重新加载；

3) **告警通知**：不一致超过阈值时告警；

4) **手动修复**：提供管理接口手动刷新缓存；

5) **日志记录**：记录不一致事件便于分析。

## 138. 数据备份与恢复

### 如何实现数据的备份？
1) **MySQL定时备份**：使用`mysqldump`定时备份数据库；

2) **Redis持久化**：开启RDB和AOF持久化；

3) **备份脚本**：编写Shell脚本自动备份；

4) **远程存储**：备份文件上传到OSS或NAS；

5) **多副本**：保留多个历史备份。

### 备份的频率应该是多少？
1) **全量备份**：每天凌晨进行全量备份；

2) **增量备份**：每小时进行增量备份；

3) **Redis快照**：每小时保存RDB快照；

4) **AOF持久化**：实时记录写操作；

5) **根据业务调整**：重要数据增加备份频率。

### 如何验证备份的完整性？
1) **备份后校验**：计算备份文件MD5校验和；

2) **定期恢复测试**：定期在测试环境恢复备份；

3) **备份大小检查**：检查备份文件大小是否正常；

4) **恢复演练**：定期进行灾难恢复演练；

5) **监控告警**：备份失败时立即告警。

### 如何进行数据的恢复？
1) **MySQL恢复**：使用`mysql < backup.sql`恢复数据库；

2) **Redis恢复**：停止Redis，替换RDB/AOF文件后重启；

3) **增量恢复**：先恢复全量备份，再应用增量备份；

4) **验证数据**：恢复后验证数据完整性；

5) **切换流量**：验证通过后切换流量到恢复的数据库。

