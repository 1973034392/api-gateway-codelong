# 19 故障处理与恢复

## 91. 故障检测

### 如何检测系统的故障？
1) **监控关键指标**：QPS、响应时间、错误率、CPU、内存占用；

2) **阈值告警**：指标超过阈值时触发告警；

3) **日志分析**：分析ERROR和WARN级别日志；

4) **健康检查接口**：定期调用系统健康检查端点；

5) **自动降级**：检测到故障时自动触发降级策略。

### 如何检测服务的故障？
1) **心跳检测**：服务每15秒发送心跳，30秒未更新则判定为故障；

2) **响应时间**：响应时间超过阈值表示服务不健康；

3) **错误率**：错误率超过50%且请求数超过10时判定为故障；

4) **连接检测**：无法建立连接表示服务故障；

5) **自动下线**：故障服务自动从负载均衡中移除。

### 如何检测网络的故障？
1) **连接超时**：连接超时5秒表示网络故障；

2) **Socket超时**：Socket超时5秒表示网络延迟高；

3) **连接拒绝**：无法建立连接表示网络故障；

4) **DNS解析失败**：无法解析域名表示网络故障；

5) **重试机制**：失败自动重试，多次失败则判定为网络故障。

### 如何检测数据库的故障？
1) **连接池检测**：连接池无可用连接表示数据库故障；

2) **查询超时**：查询超过阈值表示数据库故障；

3) **连接失败**：无法建立数据库连接表示故障；

4) **主从同步延迟**：同步延迟过大表示主从故障；

5) **降级处理**：数据库故障时使用缓存数据或返回默认值。

## 92. 故障转移

### 如何实现自动故障转移？
1) **负载均衡**：使用加权轮询算法选择健康的服务实例；

2) **健康检查**：定期检查实例健康状态，故障实例自动剔除；

3) **自动切换**：检测到故障时自动切换到其他健康实例；

4) **无需人工干预**：故障转移完全自动化，无需运维人员介入；

5) **快速恢复**：故障实例恢复后自动加入负载均衡。

### 故障转移的流程是什么？
1) **故障检测**：监控系统检测到服务故障；

2) **标记故障**：将故障实例标记为不可用；

3) **流量转移**：新请求自动转移到其他健康实例；

4) **已有连接**：已建立的连接继续使用原实例，新连接转移；

5) **恢复验证**：故障实例恢复后进行验证，确认健康后加入负载均衡。

### 如何保证故障转移的可靠性？
1) **多重检测**：使用心跳、响应时间、错误率等多个指标检测故障；

2) **冗余设计**：至少部署3个实例，保证故障转移有目标；

3) **快速转移**：故障检测到转移的时间控制在30秒内；

4) **状态同步**：使用Redis保证所有网关节点的故障状态一致；

5) **监控告警**：故障转移时立即告警，便于问题排查。

### 如何处理故障转移的失败？
1) **重试机制**：转移失败自动重试，最多重试3次；

2) **指数退避**：重试间隔逐次增加(1秒、2秒、4秒)；

3) **降级处理**：所有实例都故障时返回降级响应；

4) **人工介入**：转移失败多次时触发告警，通知运维人员；

5) **日志记录**：记录转移失败的详细信息，便于问题排查。

## 93. 故障恢复

### 故障恢复的流程是什么？
1) **故障检测**：监控系统检测到故障已解决；

2) **半开状态**：将故障实例转为半开状态，尝试恢复；

3) **试探调用**：发送少量请求到故障实例进行测试；

4) **恢复验证**：试探调用成功则判定为恢复；

5) **加入负载均衡**：恢复的实例重新加入负载均衡，接收正常流量。

### 如何恢复系统的状态？
1) **清理缓存**：清理故障期间的过期缓存数据；

2) **重新加载配置**：从数据库重新加载配置到内存缓存；

3) **同步状态**：与其他节点同步系统状态，保证一致性；

4) **重置计数器**：重置故障检测的计数器和统计数据；

5) **恢复监控**：恢复对该实例的监控和告警。

### 如何恢复数据的一致性？
1) **事务回滚**：故障期间的未提交事务自动回滚；

2) **重新同步**：从主库重新同步数据到从库；

3) **版本号检查**：使用版本号检测数据冲突并修复；

4) **定时对账**：定时任务对账数据库和缓存的数据；

5) **最终一致性**：通过定时任务修正不一致的数据。

### 如何验证故障恢复的成功？
1) **健康检查**：调用健康检查接口验证实例可用；

2) **试探请求**：发送少量请求验证功能正常；

3) **指标验证**：验证响应时间、错误率等指标恢复正常；

4) **数据验证**：验证数据库和缓存数据一致；

5) **监控观察**：观察监控面板30分钟以上，确认稳定。

## 94. 灾难恢复

### 如何实现灾难恢复？
1) **多地域部署**：在不同地域部署多个数据中心，实现异地容灾；

2) **数据备份**：定期备份数据库和配置到远程存储；

3) **主从切换**：主数据中心故障时自动切换到从数据中心；

4) **DNS切换**：通过DNS切换流量到可用的数据中心；

5) **自动化脚本**：编写自动化脚本快速恢复系统。

### 灾难恢复的流程是什么？
1) **故障检测**：检测到主数据中心完全故障；

2) **告警通知**：立即通知运维团队和相关负责人；

3) **启动恢复**：执行灾难恢复计划，启动从数据中心；

4) **数据恢复**：从备份恢复最新的数据；

5) **流量切换**：通过DNS和负载均衡切换流量到从数据中心；

6) **验证恢复**：验证系统功能正常，数据完整。

### 如何保证灾难恢复的可靠性？
1) **RPO(恢复点目标)**：数据备份频率不超过15分钟，最多丢失15分钟数据；

2) **RTO(恢复时间目标)**：灾难恢复时间不超过30分钟；

3) **备份验证**：定期验证备份的完整性和可恢复性；

4) **多副本存储**：备份存储在多个地域，防止单点故障；

5) **定期演练**：每季度进行一次灾难恢复演练。

### 如何进行灾难恢复的演练？
1) **制定计划**：编写详细的灾难恢复计划和操作手册；

2) **模拟故障**：模拟主数据中心故障场景；

3) **执行恢复**：按照计划执行灾难恢复操作；

4) **验证功能**：验证系统功能和数据完整性；

5) **总结改进**：记录演练过程中发现的问题，持续改进。

## 95. 数据备份与恢复

### 如何实现数据的备份？
1) **全量备份**：定期(如每周)进行全量备份，备份整个数据库；

2) **增量备份**：每天进行增量备份，只备份变化的数据；

3) **日志备份**：备份数据库事务日志，支持时间点恢复；

4) **异地存储**：备份存储在不同地域的存储服务(如S3、OSS)；

5) **自动化备份**：使用定时任务自动执行备份，无需人工干预。

### 备份的频率应该是多少？
1) **全量备份**：每周进行一次全量备份；

2) **增量备份**：每天进行一次增量备份；

3) **日志备份**：每小时进行一次日志备份；

4) **配置备份**：配置变更时立即备份；

5) **备份保留**：全量备份保留3个月，增量备份保留7天。

### 如何验证备份的完整性？
1) **备份校验**：计算备份文件的MD5/SHA256校验和，验证完整性；

2) **恢复测试**：定期从备份恢复数据到测试环境，验证可恢复性；

3) **数据对比**：对比恢复后的数据与原数据，确保一致；

4) **日志检查**：检查备份日志，确保备份成功；

5) **告警机制**：备份失败时立即告警，通知运维人员。

### 如何进行数据的恢复？
1) **选择备份**：根据故障时间选择合适的备份版本；

2) **恢复到测试环境**：先恢复到测试环境进行验证；

3) **数据验证**：验证恢复后的数据完整性和正确性；

4) **恢复到生产环境**：确认无误后恢复到生产环境；

5) **业务验证**：恢复后进行业务功能验证，确保系统正常。

