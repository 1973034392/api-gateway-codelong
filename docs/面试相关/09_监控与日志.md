# 09 监控与日志

## 39. 日志记录

### 系统中的日志级别有哪些？
1) **TRACE**: 最详细的日志，用于调试；

2) **DEBUG**: 调试信息，用于开发阶段；

3) **INFO**: 一般信息，记录重要事件；

4) **WARN**: 警告信息，表示可能的问题；

5) **ERROR**: 错误信息，表示发生了错误。

### 如何记录关键操作的日志？
1) **服务注册**: 记录服务注册、注销事件；

2) **心跳续约**: 记录心跳发送、接收事件；

3) **限流**: 记录限流触发事件；

4) **认证**: 记录认证成功、失败事件；

5) **异常**: 记录所有异常事件及堆栈信息。

### 如何实现日志的分级输出？
1) **配置文件**: 在logback.xml中配置日志级别；

2) **包级别**: 为不同包设置不同的日志级别；

3) **环境区分**: 开发环境DEBUG级别，生产环境INFO级别；

4) **动态调整**: 支持运行时动态调整日志级别；

5) **输出目标**: 日志输出到文件、控制台、远程服务器等。

### 如何处理日志的性能影响？
1) **异步日志**: 使用异步日志框架(如Logback的AsyncAppender)；

2) **日志缓冲**: 批量写入日志，减少I/O操作；

3) **日志采样**: 对高频日志进行采样，减少日志量；

4) **日志压缩**: 定期压缩日志文件，节省存储空间；

5) **日志清理**: 定期删除过期日志，释放磁盘空间。

## 40. 性能监控

### 系统中有哪些关键的性能指标？
1) **QPS**: 每秒处理的请求数；

2) **响应时间**: 平均响应时间、P95、P99；

3) **错误率**: 请求失败率；

4) **缓存命中率**: 缓存命中次数 / 总请求数；

5) **连接数**: 当前活跃连接数、总连接数。

### 如何监控请求的响应时间？
1) **记录时间戳**: 请求进入时记录开始时间，响应时记录结束时间；

2) **计算耗时**: 结束时间 - 开始时间 = 响应时间；

3) **统计分析**: 计算平均值、最大值、最小值、P95、P99等；

4) **告警**: 响应时间超过阈值时触发告警；

5) **可视化**: 通过监控面板展示响应时间趋势。

### 如何监控系统的吞吐量？
1) **计数器**: 使用原子计数器统计请求数；

2) **时间窗口**: 每秒统计一次请求数，得到QPS；

3) **聚合**: 将多个网关节点的QPS聚合，得到总QPS；

4) **告警**: QPS超过阈值时触发告警；

5) **可视化**: 通过监控面板展示QPS趋势。

### 如何监控缓存的命中率？
1) **命中计数**: 缓存命中时计数+1；

2) **总请求数**: 所有缓存查询请求计数+1；

3) **命中率**: 命中数 / 总数 * 100%；

4) **分级统计**: 分别统计L1缓存和L2缓存的命中率；

5) **告警**: 命中率低于阈值时触发告警，表示缓存配置不合理。

## 41. 限流监控

### 如何监控限流的拦截率？
1) **拦截计数**: 限流拒绝时计数+1；

2) **总请求数**: 所有请求计数+1；

3) **拦截率**: 拦截数 / 总数 * 100%；

4) **分级统计**: 分别统计全局、服务、接口、IP四级限流的拦截率；

5) **告警**: 拦截率过高时触发告警，表示限流配置过严格。

### 如何监控本地限流和Redis限流的效果？
1) **本地限流**: 统计本地限流器的拦截次数；

2) **Redis限流**: 统计Redis限流的拦截次数；

3) **对比分析**: 比较两者的拦截率，评估限流效果；

4) **异常检测**: 如果Redis限流异常，本地限流应该接管；

5) **性能指标**: 监控限流检查的耗时。

### 如何监控限流配置的更新？
1) **更新事件**: 记录限流配置的创建、更新、删除事件；

2) **变更内容**: 记录配置变更的具体内容；

3) **生效时间**: 记录配置生效的时间；

4) **影响范围**: 统计配置变更影响的网关节点数；

5) **验证**: 验证配置变更是否正确生效。

### 如何监控限流的异常情况？
1) **Redis异常**: 监控Redis连接异常，记录降级事件；

2) **配置异常**: 监控限流配置的异常(如参数无效)；

3) **性能异常**: 监控限流检查的耗时异常；

4) **告警**: 异常情况发生时触发告警；

5) **恢复**: 记录异常恢复的时间。

## 42. 服务监控

### 如何监控服务实例的健康状态？
1) **心跳检测**: 通过心跳判断服务是否在线；

2) **响应时间**: 监控服务的响应时间，响应缓慢表示不健康；

3) **错误率**: 监控服务的错误率，错误率高表示不健康；

4) **资源占用**: 监控服务的CPU、内存占用；

5) **自动下线**: 不健康的实例自动下线，不再接收请求。

### 如何监控服务的可用性？
1) **在线实例数**: 统计服务的在线实例数；

2) **可用性**: 可用性 = 在线实例数 / 总实例数 * 100%；

3) **告警**: 可用性低于阈值时触发告警；

4) **自动转移**: 实例下线时自动转移请求到其他实例；

5) **恢复**: 实例恢复后自动加入负载均衡。

### 如何监控服务的响应时间？
1) **记录时间**: 请求发送时记录开始时间，收到响应时记录结束时间；

2) **计算耗时**: 结束时间 - 开始时间 = 响应时间；

3) **统计分析**: 计算平均值、最大值、最小值、P95、P99等；

4) **告警**: 响应时间超过阈值时触发告警；

5) **可视化**: 通过监控面板展示响应时间趋势。

### 如何监控服务的错误率？
1) **错误计数**: 请求失败时计数+1；

2) **总请求数**: 所有请求计数+1；

3) **错误率**: 错误数 / 总数 * 100%；

4) **分类统计**: 按错误类型(超时、异常、业务错误等)分类统计；

5) **告警**: 错误率超过阈值时触发告警，表示服务故障。

