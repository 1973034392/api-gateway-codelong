# 21 运维与监控

## 101. 日志收集与分析

### 如何收集系统的日志？
本项目使用Logback作为日志框架，通过分级日志记录关键操作：

1) **服务注册日志**：记录服务注册、心跳续约事件；

2) **限流日志**：记录限流拒绝、配置更新事件；

3) **认证日志**：记录Token验证成功/失败；

4) **异常日志**：记录ERROR级别异常及堆栈信息；

5) **性能日志**：记录请求响应时间、QPS等指标。日志输出到文件和控制台，支持异步日志避免阻塞主流程。

### 如何分析日志以发现问题？
1) **关键字搜索**：通过ERROR、WARN关键字快速定位问题；

2) **请求追踪**：通过URI追踪完整请求链路；

3) **时间分析**：分析特定时间段的日志找出异常模式；

4) **统计分析**：统计限流拒绝率、错误率等指标；

5) **堆栈分析**：分析异常堆栈定位代码问题。项目中关键日志包括：`log.error("Redis限流异常，降级为本地限流")`、`log.warn("限流拒绝: type={}, target={}, ip={}")`等。

### 如何使用ELK进行日志分析？
虽然项目未直接集成ELK，但可通过以下方式集成：

1) **Logstash收集**：配置Logstash从日志文件或Logback直接输出收集日志；

2) **Elasticsearch存储**：将日志存储到ES，支持全文检索；

3) **Kibana可视化**：创建Dashboard展示QPS、错误率、限流拒绝率等指标；

4) **告警配置**：通过ElastAlert配置告警规则；

5) **日志格式**：使用JSON格式输出日志便于解析。

### 如何设置日志的告警？
基于日志内容设置告警规则：

1) **错误率告警**：ERROR日志数量超过阈值（如>100/分钟）触发告警；

2) **限流告警**：限流拒绝率>10%时告警；

3) **Redis异常告警**：Redis连接异常日志出现时立即告警；

4) **配置更新失败告警**：配置推送失败日志触发告警；

5) **响应超时告警**：请求超时日志频繁出现时告警。可通过ELK的ElastAlert或自定义日志监控脚本实现。

## 102. 指标收集与监控

### 如何收集系统的指标？
项目通过代码埋点收集关键指标：

1) **QPS统计**：使用AtomicInteger统计每秒请求数；

2) **响应时间**：记录请求开始和结束时间戳计算耗时；

3) **限流指标**：统计限流拒绝次数和拦截率；

4) **缓存指标**：统计L1/L2缓存命中率；

5) **连接池指标**：监控HTTP连接池活跃连接数、使用率。这些指标可存储到Redis或时序数据库供监控系统查询。

### 如何使用Prometheus进行指标收集？
可通过Spring Boot Actuator集成Prometheus：

1) **添加依赖**：引入`micrometer-registry-prometheus`；

2) **暴露端点**：配置`/actuator/prometheus`端点；

3) **自定义指标**：使用`MeterRegistry`注册自定义指标如限流拒绝率、缓存命中率；

4) **Prometheus抓取**：配置Prometheus定期抓取指标；

5) **指标类型**：Counter（请求总数）、Gauge（当前连接数）、Histogram（响应时间分布）。

### 如何使用Grafana进行指标可视化？
1) **数据源配置**：添加Prometheus作为数据源；

2) **创建Dashboard**：创建网关监控面板；

3) **关键图表**：QPS趋势图、响应时间P95/P99曲线、错误率折线图、限流拒绝率、缓存命中率；

4) **告警配置**：在Grafana中配置告警规则；

5) **变量过滤**：支持按服务、接口、实例过滤查看。

### 如何设置指标的告警？
基于关键指标设置告警阈值：

1) **QPS告警**：QPS超过系统容量（如>10000）时告警；

2) **响应时间告警**：P99响应时间>1秒时告警；

3) **错误率告警**：错误率>5%时告警；

4) **限流拒绝率告警**：拒绝率>10%时告警，表示限流配置过严或流量激增；

5) **缓存命中率告警**：命中率<80%时告警，表示缓存配置不合理。告警通过钉钉、邮件、短信等方式通知。

## 103. 链路追踪

### 什么是链路追踪？
链路追踪是分布式系统中追踪一个请求完整调用链路的技术。在本网关系统中，一个请求的链路包括：客户端 → Nginx → 网关核心 → 后端服务（HTTP/Dubbo）。链路追踪可以记录每个环节的耗时、状态、异常信息，帮助定位性能瓶颈和故障点。核心概念包括TraceId（全局唯一请求ID）、SpanId（调用链中的节点ID）、时间戳、标签等。

### 如何使用Jaeger进行链路追踪？
虽然项目未直接集成Jaeger，但可通过以下方式集成：

1) **添加依赖**：引入`opentracing-spring-jaeger-web-starter`；

2) **配置Jaeger**：配置Jaeger Agent地址和采样率；

3) **自动埋点**：Spring Boot自动为HTTP请求创建Span；

4) **手动埋点**：在关键代码处创建子Span记录耗时；

5) **异步调用追踪**：使用`@NewSpan`注解追踪CompletableFuture异步调用。

### 如何追踪异步请求的链路？
本项目大量使用异步调用（HTTP异步、Dubbo异步），追踪异步链路需要：

1) **TraceId传递**：在CompletableFuture中传递TraceId上下文；

2) **Span创建**：为每个异步任务创建子Span；

3) **时间记录**：记录异步任务开始和结束时间；

4) **异常捕获**：在exceptionally中记录异常信息到Span；

5) **关联关系**：通过ParentSpanId关联父子Span。可使用OpenTracing的`Scope`机制自动传递上下文。

### 如何分析链路追踪的结果？
1) **耗时分析**：查看每个Span的耗时，找出最慢的环节；

2) **调用关系**：通过Span树形结构理解调用关系；

3) **异常定位**：查看标记为Error的Span定位异常；

4) **性能对比**：对比不同时间段的链路耗时发现性能退化；

5) **瓶颈识别**：找出耗时占比最大的Span进行优化。例如发现Dubbo调用耗时过长，可优化网络或后端服务。

## 104. 告警与通知

### 如何设置告警规则？
基于项目实际场景设置告警规则：

1) **限流告警**：限流拒绝率>10%持续5分钟触发告警；

2) **Redis异常告警**：Redis异常率>1%立即告警；

3) **配置更新告警**：配置更新延迟>1秒或加载失败触发告警；

4) **服务健康告警**：心跳超时30秒服务自动下线并告警；

5) **系统资源告警**：CPU>80%、内存>85%、连接池使用率>90%时告警。告警规则需考虑持续时间避免误报。

### 如何实现告警的通知？
1) **通知渠道**：支持钉钉机器人、企业微信、邮件、短信等多种渠道；

2) **分级通知**：P0级别（系统不可用）电话+短信，P1级别（功能异常）钉钉+邮件，P2级别（性能下降）仅钉钉；

3) **通知内容**：包含告警时间、告警指标、当前值、阈值、影响范围、处理建议；

4) **通知频率**：同一告警5分钟内最多通知1次避免骚扰；

5) **值班轮换**：配置值班表自动通知当前值班人员。

### 如何处理告警的误报？
1) **阈值调优**：根据历史数据调整告警阈值，避免正常波动触发告警；

2) **持续时间**：要求指标异常持续一定时间（如5分钟）才告警；

3) **白名单**：对已知的临时异常（如发布期间）设置告警白名单；

4) **智能告警**：使用机器学习识别异常模式，减少规则告警的误报；

5) **告警收敛**：同一问题的多个告警合并为一条，避免告警风暴。

### 如何优化告警的规则？
1) **数据驱动**：基于历史数据分析设置合理阈值；

2) **分级告警**：根据影响程度设置不同级别的告警；

3) **动态阈值**：根据时间段（工作日/周末、白天/夜间）动态调整阈值；

4) **组合条件**：多个指标同时异常才告警，提高准确性；

5) **定期Review**：每月Review告警规则，删除无效告警，优化误报告警。例如限流告警可结合QPS和错误率综合判断。

## 105. 容量规划

### 如何评估系统的容量？
基于压测结果评估容量：

1) **单实例QPS**：通过JMeter压测得出单个网关核心实例可支持QPS约5000-8000（取决于后端服务响应时间）；

2) **总容量计算**：总容量 = 单实例QPS × 实例数量 × 0.7（留30%余量）；

3) **响应时间**：P99响应时间<500ms为合格；

4) **资源占用**：单实例CPU<70%、内存<80%、连接池使用率<80%；

5) **并发连接**：Netty单实例可支持数万并发连接。

### 如何进行容量规划？
1) **业务预测**：根据业务增长预测未来3-6个月的流量；

2) **峰值规划**：按日常流量的3-5倍规划峰值容量；

3) **实例规划**：预期峰值QPS 50000，单实例5000 QPS，需要部署15个实例（含余量）；

4) **资源规划**：每个实例配置4核8G，共需60核120G；

5) **成本优化**：使用弹性伸缩在低峰期缩容节省成本。

### 如何识别容量的瓶颈？
通过监控指标识别瓶颈：

1) **CPU瓶颈**：CPU使用率持续>80%，优化异步处理和减少锁竞争；

2) **内存瓶颈**：内存使用率>85%且频繁GC，优化缓存大小和对象创建；

3) **网络瓶颈**：网络带宽打满，优化数据传输和启用压缩；

4) **连接池瓶颈**：连接池使用率>90%且有等待，增加连接池大小；

5) **后端瓶颈**：网关响应快但整体慢，优化后端服务或增加后端实例。

### 如何进行容量的扩展？
本项目支持水平扩展：

1) **网关核心扩展**：启动新的网关核心实例，通过心跳自动注册到网关中心，Nginx自动更新upstream配置实现负载均衡；

2) **配置同步**：新实例启动时从Redis拉取全量配置，后续通过Pub/Sub实时同步；

3) **无状态设计**：网关核心无状态，可任意扩缩容；

4) **灰度扩容**：新实例先设置低权重观察稳定性，确认无问题后调整为正常权重；

5) **自动扩缩容**：基于CPU、QPS等指标配置自动扩缩容策略。

