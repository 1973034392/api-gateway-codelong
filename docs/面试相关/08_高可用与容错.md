# 08 高可用与容错

## 35. 熔断降级机制

### 熔断和降级的区别是什么？
**熔断**:

1) 当后端服务故障时，自动停止调用该服务；

2) 快速失败，返回错误响应；

3) 保护后端服务不被过载；

4) 有三种状态：CLOSED(正常)、OPEN(熔断)、HALF_OPEN(半开)。


**降级**:

1) 当系统资源不足或服务故障时，返回降级响应；

2) 返回缓存数据或默认值；

3) 保证系统可用性；

4) 是一种主动的容错策略。

### 如何实现自动熔断？
1) **错误率检测**: 统计服务的失败次数和总请求数；

2) **阈值判断**: 当失败率超过阈值(如50%)且请求数超过最小值(如10)时，熔断器转为OPEN状态；

3) **快速失败**: OPEN状态下直接返回错误，不调用后端服务；

4) **自动恢复**: 经过超时时间(如30秒)后转为HALF_OPEN，尝试恢复；

5) **恢复验证**: HALF_OPEN状态下尝试调用，成功则转为CLOSED，失败则转为OPEN。

### 熔断后如何恢复？
1) **超时转换**: 熔断器OPEN状态经过超时时间(如30秒)后自动转为HALF_OPEN；

2) **试探调用**: HALF_OPEN状态下尝试调用后端服务；

3) **成功恢复**: 调用成功则转为CLOSED，恢复正常；

4) **失败重新熔断**: 调用失败则转为OPEN，继续熔断；

5) **手动恢复**: 可手动重置熔断器，强制转为CLOSED。

### 如何监控熔断事件？
1) **状态变化**: 记录熔断器状态变化(CLOSED→OPEN→HALF_OPEN→CLOSED)；

2) **错误率**: 监控服务的错误率、失败次数；

3) **告警**: 熔断事件发生时触发告警，通知运维人员；

4) **指标收集**: 收集熔断次数、恢复次数等指标；

5) **可视化**: 通过监控面板展示熔断状态和趋势。

## 36. 异常处理机制

### 系统中有哪些异常类型？
1) **业务异常**: 参数验证失败、业务规则违反等；

2) **系统异常**: 数据库连接失败、Redis异常等；

3) **网络异常**: 请求超时、连接拒绝等；

4) **认证异常**: 令牌无效、权限不足等；

5) **限流异常**: 请求被限流拒绝。

### 如何实现全局异常处理？
1) **处理器链**: 在处理器链中使用try-catch捕获异常；

2) **异常转换**: 将异常转换为统一的Result对象；

3) **错误响应**: 返回HTTP 200状态码，但Result中包含错误信息；

4) **日志记录**: 记录异常堆栈，便于问题排查；

5) **降级处理**: 异常时返回默认值或降级响应。

### 异常如何转换为响应结果？
1) **Result对象**: 使用统一的Result类封装响应；

2) **错误码**: 为不同异常类型定义错误码；

3) **错误信息**: 提供用户友好的错误信息；

4) **数据字段**: 异常时data字段为null；

5) **HTTP状态码**: 通常返回200，错误信息在Result中。

### 如何记录异常日志？
1) **日志级别**: 使用ERROR级别记录异常；

2) **堆栈信息**: 记录完整的异常堆栈，便于问题排查；

3) **上下文信息**: 记录请求信息、用户信息等上下文；

4) **异步记录**: 使用异步日志框架，避免阻塞主流程；

5) **日志聚合**: 使用ELK等日志聚合系统，便于查询分析。

## 37. 服务降级策略

### 什么时候触发服务降级？
1) **系统过载**: 当系统QPS超过阈值时触发降级；

2) **服务故障**: 当后端服务故障或响应缓慢时触发降级；

3) **资源不足**: 当系统资源(CPU、内存)不足时触发降级；

4) **手动触发**: 运维人员可手动触发降级；

5) **自动恢复**: 系统恢复正常后自动取消降级。

### 如何实现服务降级？
1) **返回缓存**: 返回之前缓存的响应数据；

2) **返回默认值**: 返回预定义的默认值；

3) **简化逻辑**: 执行简化版本的业务逻辑；

4) **限制功能**: 关闭非核心功能，保留核心功能；

5) **队列缓冲**: 将请求放入队列，异步处理。

### 降级后的服务质量如何保证？
1) **缓存数据**: 返回的缓存数据是最近的有效数据；

2) **默认值**: 默认值是合理的、安全的值；

3) **用户提示**: 告知用户系统处于降级状态；

4) **时间限制**: 降级持续时间有限，避免长期降级；

5) **监控恢复**: 监控系统状态，及时恢复到正常。

### 如何监控降级事件？
1) **降级触发**: 记录降级触发的原因和时间；

2) **降级持续**: 监控降级持续时间；

3) **恢复时间**: 记录降级恢复的时间；

4) **影响范围**: 统计降级影响的请求数；

5) **告警通知**: 降级事件发生时通知运维人员。

## 38. 分布式事务处理

### 系统中是否涉及分布式事务？
1) **有限涉及**: 网关主要是请求转发，不涉及复杂的分布式事务；

2) **服务调用**: 调用后端服务时可能涉及分布式事务；

3) **配置同步**: 配置变更时需要保证多个网关节点的一致性；

4) **心跳续约**: 心跳更新涉及Redis和数据库的一致性；

5) **限流配置**: 限流配置变更需要同步到所有网关节点。

### 如何保证数据的一致性？
1) **数据库事务**: 单个操作使用数据库事务保证一致性；

2) **Redis Pub/Sub**: 配置变更时发布消息，所有节点同时更新；

3) **版本号机制**: 为配置添加版本号，避免旧配置覆盖新配置；

4) **定时同步**: 定时任务从数据库同步数据到Redis；

5) **最终一致性**: 采用最终一致性模型，保证数据最终一致。

### 如何处理事务失败的情况？
1) **重试机制**: 事务失败时自动重试，最多重试3次；

2) **指数退避**: 重试间隔逐次增加，避免频繁重试；

3) **日志记录**: 记录失败事件，便于问题排查；

4) **告警通知**: 重试全部失败时触发告警；

5) **人工介入**: 告警后由运维人员手动处理。

### 如何实现事务的回滚？
1) **数据库回滚**: 使用数据库事务的回滚机制；

2) **缓存清理**: 事务失败时清理已更新的缓存；

3) **消息撤销**: 已发布的消息无法撤销，需要补偿操作；

4) **补偿事务**: 执行反向操作恢复数据；

5) **人工处理**: 复杂情况下由运维人员手动处理。

