# 11 部署与运维

## 47. 系统部署

### 系统的部署架构是什么？
1) **网关中心**: 部署在中心节点，管理配置和服务信息；

2) **网关核心**: 部署多个实例，处理请求；

3) **服务提供者**: 部署多个实例，提供业务服务；

4) **Redis**: 中心化存储，所有节点共享；

5) **数据库**: 存储持久化数据，支持主从复制。

### 如何实现网关的高可用部署？
1) **多实例部署**: 部署多个网关核心实例；

2) **负载均衡**: 使用Nginx进行负载均衡；

3) **故障转移**: 实例故障时自动转移到其他实例；

4) **健康检查**: 定期检查实例健康状态；

5) **自动扩缩容**: 根据负载自动增加或减少实例。

### 如何配置负载均衡？
1) **轮询**: 按顺序将请求分配到各个实例；

2) **加权轮询**: 根据权重分配请求；

3) **最少连接**: 将请求分配到连接数最少的实例；

4) **IP哈希**: 根据客户端IP分配到固定实例；

5) **健康检查**: 故障实例自动剔除。

### 如何实现灰度发布？
1) **金丝雀发布**: 先在少量实例上发布新版本；

2) **流量切割**: 逐步增加新版本的流量比例；

3) **监控对比**: 监控新旧版本的性能指标；

4) **快速回滚**: 发现问题时立即回滚；

5) **全量发布**: 确认新版本稳定后进行全量发布。

## 48. 配置管理

### 如何管理不同环境的配置？
1) **配置文件**: 为不同环境创建不同的配置文件(application-dev.yml、application-prod.yml)；

2) **环境变量**: 使用环境变量覆盖配置文件中的值；

3) **配置中心**: 使用配置中心(如Apollo、Nacos)统一管理配置；

4) **优先级**: 环境变量 > 配置中心 > 配置文件；

5) **验证**: 启动时验证配置的有效性。

### 如何实现配置的热更新？
1) **Redis Pub/Sub**: 配置变更时发布消息到Redis；

2) **消息监听**: 网关核心监听配置更新消息；

3) **本地更新**: 收到消息后更新本地配置缓存；

4) **无需重启**: 配置更新无需重启应用；

5) **原子性**: 确保配置更新的原子性，避免部分更新。

### 如何处理配置的版本管理？
1) **版本号**: 为每个配置版本添加版本号；

2) **变更记录**: 记录每次配置变更的内容和时间；

3) **版本对比**: 支持查看不同版本的配置差异；

4) **版本回滚**: 支持回滚到任意历史版本；

5) **审计日志**: 记录谁在什么时间做了什么配置变更。

### 如何回滚错误的配置？
1) **快速回滚**: 发现问题时立即回滚到上一个版本；

2) **自动回滚**: 配置变更后监控指标异常时自动回滚；

3) **手动回滚**: 支持手动选择要回滚的版本；

4) **验证**: 回滚前验证目标版本的有效性；

5) **通知**: 回滚完成后通知相关人员。

## 49. 故障排查

### 如何排查请求处理失败的问题？
1) **查看日志**: 查看网关和后端服务的日志，找出错误信息；

2) **追踪请求**: 使用请求ID追踪请求的完整处理流程；

3) **检查配置**: 验证接口配置、路由配置是否正确；

4) **测试接口**: 使用curl或Postman测试接口；

5) **监控指标**: 查看错误率、响应时间等指标。

### 如何排查缓存不一致的问题？
1) **检查缓存**: 查看L1缓存和L2缓存中的数据；

2) **对比数据库**: 将缓存数据与数据库数据对比；

3) **查看日志**: 查看缓存更新的日志；

4) **清理缓存**: 清理不一致的缓存，重新加载；

5) **监控**: 监控缓存命中率，发现异常。

### 如何排查限流不生效的问题？
1) **检查配置**: 验证限流配置是否正确；

2) **查看日志**: 查看限流处理的日志；

3) **测试限流**: 发送大量请求测试限流是否生效；

4) **检查Redis**: 验证Redis连接是否正常；

5) **监控**: 监控限流的拦截率。

### 如何排查性能下降的问题？
1) **监控指标**: 查看QPS、响应时间、错误率等指标；

2) **分析日志**: 查看慢查询日志、异常日志；

3) **检查资源**: 检查CPU、内存、磁盘使用情况；

4) **性能分析**: 使用性能分析工具(如JProfiler)分析代码；

5) **优化**: 根据分析结果进行优化。

## 50. 容量规划

### 如何评估系统的容量？
1) **基准测试**: 进行基准测试，测试单个实例的QPS；

2) **计算容量**: 容量 = 单实例QPS × 实例数量；

3) **留有余量**: 容量规划时留有20-30%的余量；

4) **考虑峰值**: 考虑业务峰值，确保能应对峰值流量；

5) **定期评估**: 定期重新评估容量，根据业务增长调整。

### 如何进行压力测试？
1) **测试工具**: 使用压力测试工具(如JMeter、LoadRunner)；

2) **测试场景**: 设计多种测试场景(正常、峰值、异常)；

3) **逐步增压**: 逐步增加并发数，观察系统表现；

4) **监控指标**: 监控QPS、响应时间、错误率等指标；

5) **分析结果**: 分析测试结果，找出瓶颈。

### 如何识别系统的瓶颈？
1) **监控指标**: 监控各个组件的性能指标；

2) **分析日志**: 分析日志找出耗时操作；

3) **性能分析**: 使用性能分析工具找出热点代码；

4) **数据库分析**: 分析数据库查询性能；

5) **网络分析**: 分析网络延迟。

### 如何进行容量扩展？
1) **水平扩展**: 增加网关核心实例数量；

2) **垂直扩展**: 增加单个实例的资源(CPU、内存)；

3) **优化代码**: 优化代码性能，提高单实例QPS；

4) **缓存优化**: 优化缓存策略，提高命中率；

5) **数据库优化**: 优化数据库查询，提高查询速度。

