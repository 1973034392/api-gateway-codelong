# 06 数据存储与持久化

## 29. Redis数据结构设计

### Redis中如何存储接口配置信息？
1) **Key**: `gateway:interface:{serviceId}:{url}`；

2) **Type**: Hash；

3) **Fields**: 包含接口名、HTTP方法、参数类型、返回类型、是否认证等；

4) **示例**: `gateway:interface:user-service:/api/user/list`；

5) **过期时间**: 无过期时间，除非主动删除。

### Redis中如何存储服务实例信息？
1) **Key**: `heartbeat:server:{serviceName}:{address}`或`heartbeat:group:{serverName}:{address}`；

2) **Type**: Hash；

3) **Fields**: `lastTime`(最后更新时间)、`startTime`(启动时间)、`url`(服务地址)、`weight`(权重)；

4) **过期时间**: 30秒(TTL)；

5) **自动清理**: 过期后自动删除，服务自动下线。

### Redis中如何存储心跳信息？
1) **Key**: `heartbeat:server:{serviceName}:{address}`；

2) **Type**: Hash；

3) **Fields**: `lastTime`(最后心跳时间)、`startTime`(启动时间)、`url`(服务地址)、`weight`(权重)；

4) **更新机制**: 每次心跳更新`lastTime`字段，重置30秒过期时间；

5) **检测机制**: 定时任务检查过期记录，自动清理僵尸节点。

### Redis中如何存储限流配置？
1) **Key**: `rate_limit:{limitType}:{limitTarget}`；

2) **Type**: String或Hash；

3) **内容**: 限流阈值、时间窗口、限流策略等；

4) **示例**: `rate_limit:GLOBAL:GLOBAL`、`rate_limit:SERVICE:user-service`；

5) **更新**: 配置变更时发布消息到`rate-limit-config-update`频道，网关核心实时更新。

## 30. 数据库表设计

### 网关中心的核心数据表有哪些？
1) **gateway_group**: 网关分组表，存储分组信息；

2) **gateway_server**: 网关服务表，存储服务提供者信息；

3) **gateway_interface**: 接口表，存储接口元数据；

4) **gateway_rate_limit**: 限流配置表，存储限流规则；

5) **gateway_group_detail**: 网关分组详情表，存储分组与网关的关系。

### 各个表之间的关系是什么？
1) **gateway_group** ← → **gateway_group_detail**: 一对多关系，一个分组对应多个网关；

2) **gateway_group** ← → **gateway_server**: 一对多关系，一个分组对应多个服务；

3) **gateway_server** ← → **gateway_interface**: 一对多关系，一个服务对应多个接口；

4) **gateway_rate_limit**: 独立表，存储全局限流配置；

5) **外键约束**: 通过serviceId、groupId等字段建立关系。

### 如何设计表结构以支持高并发查询？
1) **索引设计**: 为常用查询字段建立索引(如serviceId、url、limitType)；

2) **分区策略**: 大表可按时间或ID分区，提高查询效率；

3) **冗余字段**: 适度冗余常用字段，避免多表JOIN；

4) **缓存策略**: 热数据存储到Redis，减少数据库查询；

5) **查询优化**: 使用MyBatis-Plus的条件查询，避免全表扫描。

### 如何实现表数据与Redis的同步？
1) **写入同步**: 数据写入数据库后，同时写入Redis；

2) **删除同步**: 数据删除时，同时删除Redis中的对应记录；

3) **更新同步**: 数据更新时，更新Redis中的记录；

4) **定时同步**: 定时任务定期从数据库同步数据到Redis，保证最终一致性；

5) **事件驱动**: 使用Redis Pub/Sub发布更新事件，网关核心实时更新本地缓存。

